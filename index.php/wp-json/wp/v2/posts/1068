{"id":1068,"date":"2022-12-08T19:34:00","date_gmt":"2022-12-08T19:34:00","guid":{"rendered":"https:\/\/plainswipe.com\/?p=1068"},"modified":"2022-12-08T19:34:00","modified_gmt":"2022-12-08T19:34:00","slug":"practical-guide-for-training-or-fine-tuning-large-language-models","status":"publish","type":"post","link":"http:\/\/localhost:8000\/index.php\/practical-guide-for-training-or-fine-tuning-large-language-models\/","title":{"rendered":"Practical guide for training or fine tuning large language models"},"content":{"rendered":"\n<p>Imagine if you can connect to a friends computer and use that to speed up training of your model.<\/p>\n\n\n\n<p>Training ML models is very expensive, and ML techniques require many iterations hence they require speed.<\/p>\n\n\n\n<h4 class=\"wp-block-heading\">The Solution: Distributed Computing <\/h4>\n\n\n\n<p>Distributed training is a technique that allows you to train machine learning models using multiple computers. This can be useful when you have large datasets or models that are too computationally intensive to train on a single computer.<\/p>\n\n\n\n<p>Changing is setting up the infrastructure to enable multiple computers to work together. One way to do this is to use a Common Internet File System (CIFS) to share data and resources between the computers.<\/p>\n\n\n\n<p>To set up a CIFS, you can use a single script that is capable of running on multiple operating systems (OS). This script can be used to install the necessary software and configure the CIFS on each computer. For example, on a Linux computer, the script can install the CIFS utilities and configure the Samba server, while on a MacOS or Windows computer, the script can install the SMBFS or SAMBA command-line utilities and mount the shared directory.<\/p>\n\n\n\n<p>Once the CIFS is set up, you can start the model training process on each computer. By starting the same training process on different computers, you can connect the various training processes and allow them to communicate with each other.<\/p>\n\n\n\n<p>The various training processes communicate with each other using a process called message passing. This involves sending messages between the computers to exchange information about the model training, such as the gradients of the model parameters. The computers also discover each other using a process called process discovery. This involves identifying the other computers that are part of the distributed training process and determining how to communicate with them.<\/p>\n\n\n\n<p>In summary, distributed training allows you to train machine learning models using multiple computers. By setting up a CIFS and starting the same training process on different computers, you can connect the various training processes and enable them to communicate and discover each other. This can be useful when you have large datasets or models that are too computationally intensive to train on a single computer.<\/p>\n\n\n\n<h4 class=\"wp-block-heading\">How to start, stop training on the various computers?<\/h4>\n\n\n\n<p>To start and stop model training on the computers connected to a Common Internet File System (CIFS) using PyTorch, you can use the following techniques:<\/p>\n\n\n\n<ol>\n<li>Start training on all computers simultaneously: You can start training on all computers simultaneously by running the training script on each computer at the same time. This can be done manually by starting the script on each computer, or automatically using a tool like <code>fabric<\/code> or <code>ansible<\/code>.<\/li>\n\n\n\n<li>Start training on one computer and then add more computers: You can start training on one computer and then add more computers to the training process as needed. To do this, you can use the <code>torch.nn.DataParallel<\/code> wrapper to parallelize the model training across the computers. You can then add more computers to the training process by adding them to the <code>DataParallel<\/code> wrapper. For example:<\/li>\n<\/ol>\n\n\n\n<p><\/p>\n\n\n\n<pre class=\"wp-block-preformatted\">import torch<br \/><br \/># Set the data directory to the mount point<br \/>data_dir = \"\/path\/to\/mount\/point\"<br \/><br \/># Load the dataset<br \/>dataset = torch.utils.data.DatasetFolder(data_dir, ...)<br \/><br \/># Set up the model and DataParallel wrapper with one computer<br \/>model = MyModel()<br \/>model = torch.nn.DataParallel(model, device_ids=[0])<br \/><br \/># Use DataParallel to parallelize the model training<br \/>for input, target in dataset:<br \/>    output = model(input)<br \/>    loss = loss_fn(output, target)<br \/>    loss.backward()<br \/>    optimizer.step()<br \/><br \/># Add more computers to the DataParallel wrapper<br \/>model = torch.nn.DataParallel(model, device_ids=[0, 1, 2])<br \/><\/pre>\n\n\n\n<p>This will allow you to start training on one computer and then add more computers to the training process as needed.<\/p>\n\n\n\n<ol start=\"3\">\n<li>Stop training on one or more computers: To stop training on one or more computers, you can simply stop the training script on those computers.<\/li>\n<\/ol>\n\n\n\n<h2 class=\"wp-block-heading\">Code that demonstrates and tests the CLIFS set up<\/h2>\n\n\n\n<p>To demonstrate and test the Common Internet File System (CIFS) set up, you can write a Python script that performs the following tasks:<\/p>\n\n\n\n<ol>\n<li>Create a test file on one of the computers.<\/li>\n\n\n\n<li>Check if the test file is accessible from the other computers.<\/li>\n\n\n\n<li>Modify the test file on one of the computers.<\/li>\n\n\n\n<li>Check if the modifications are reflected on the other computers.<\/li>\n<\/ol>\n\n\n\n<p>Here is an example of a Python script that demonstrates and tests the CIFS set up:<\/p>\n\n\n\n<pre class=\"wp-block-preformatted\">import os<br \/><br \/># Create a test file on one of the computers<br \/>with open(\"Z:\/test.txt\", \"w\") as f:<br \/>    f.write(\"This is a test file.\")<br \/><br \/># Check if the test file is accessible from the other computers<br \/>if os.path.exists(\"\/path\/to\/mount\/point\/test.txt\"):<br \/>    print(\"Test file is accessible from the other computers.\")<br \/>else:<br \/>    print(\"Test file is not accessible from the other computers.\")<br \/><br \/># Modify the test file on one of the computers<br \/>with open(\"Z:\/test.txt\", \"a\") as f:<br \/>    f.write(\"\\nThis line was added later.\")<br \/><br \/># Check if the modifications are reflected on the other computers<br \/>with open(\"\/path\/to\/mount\/point\/test.txt\", \"r\") as f:<br \/>    content = f.read()<br \/>    if \"This line was added later.\" in content:<br \/>        print(\"Modifications are reflected on the other computers.\")<br \/>    else:<br \/>        print(\"Modifications are not reflected on the other computers<br \/><\/pre>\n\n\n\n<h4 class=\"wp-block-heading\">Setting up CIFS<\/h4>\n\n\n\n<p>Here is a Python script that you can use to detect the operating system, IP address, and set up a Common Internet File System (CIFS) on each computer:<\/p>\n\n\n\n<pre class=\"wp-block-preformatted\">import platform<br \/>import os<br \/><br \/># Detect the operating system<br \/>os_name = platform.system()<br \/><br \/># Get the IP address<br \/>ip_address = os.popen('hostname -I').read()<br \/>ip_address = ip_address.strip()<br \/><br \/># Set up the CIFS file system<br \/>if os_name == \"Linux\":<br \/>    # Install the CIFS utilities<br \/>    os.system(\"sudo apt-get install cifs-utils\")<br \/><br \/>    # Create a shared directory<br \/>    os.system(\"mkdir \/path\/to\/shared\/directory\")<br \/><br \/>    # Edit the Samba configuration file<br \/>    with open(\"\/etc\/samba\/smb.conf\", \"a\") as f:<br \/>        f.write(\"\\n[shared]\\n\")<br \/>        f.write(\"path = \/path\/to\/shared\/directory\\n\")<br \/>        f.write(\"writable = yes\\n\")<br \/>        f.write(\"guest ok = yes\\n\")<br \/><br \/>    # Restart the Samba server<br \/>    os.system(\"sudo systemctl restart smbd\")<br \/><br \/>elif os_name == \"Darwin\":<br \/>    # Install the SMBFS or SAMBA command-line utilities<br \/>    os.system(\"brew install smbfs\")<br \/>    # or<br \/>    os.system(\"brew install samba\")<br \/><br \/>    # Create a mount point<br \/>    os.system(\"mkdir \/path\/to\/mount\/point\")<br \/><br \/>    # Mount the shared directory<br \/>    os.system(\"sudo mount_smbfs \/\/guest@{}\/shared \/path\/to\/mount\/point\".format(ip_address))<br \/><br \/>elif os_name == \"Windows\":<br \/>    # Mount the shared directory using the \"net use\" command<br \/>    os.system(\"net use Z: \\\\\\\\{}\\\\shared\".format(ip_address))<br \/><br \/>else:<br \/>    print(\"Unsupported operating system.\")<br \/><br \/>print(\"CIFS file system set up complete.\")<br \/><\/pre>\n\n\n\n<h2 class=\"wp-block-heading\">Tying it up all together<\/h2>\n\n\n\n<p>To set up a distributed training environment on multiple computers using a main computer and the username and password provided by the computer owners, you can use a tool that automates the installation and configuration of software on remote servers. One such tool is <code>ansible<\/code>, which is a configuration management tool that allows you to define the desired state of your infrastructure and then automatically enforce that state.<\/p>\n\n\n\n<p>Here is an example of how you can use <code>ansible<\/code> to set up a distributed training environment on multiple computers, including the Common Internet File System (CIFS), PyTorch, training script, dataset, etc., and then execute the training:<\/p>\n\n\n\n<ol>\n<li>Write an <code>ansible<\/code> playbook that specifies the required steps to set up the training environment. For example:<\/li>\n<\/ol>\n\n\n\n<pre class=\"wp-block-preformatted\">---<br \/>- name: Set up distributed training environment<br \/>  hosts: all<br \/>  tasks:<br \/>    - name: Install Python<br \/>      package:<br \/>        name: python3<br \/>      become: yes<br \/><br \/>    - name: Install PyTorch<br \/>      pip:<br \/>        name: torch<br \/>      become: yes<br \/><br \/>    - name: Install CIFS utilities<br \/>      package:<br \/>        name: cifs-utils<br \/>      become: yes<br \/><br \/>    - name: Mount shared directory<br \/>      mount:<br \/>        path: \/path\/to\/mount\/point<br \/>        src: \/\/10.0.0.1\/shared<br \/>        fstype: cifs<br \/>        opts: username=guest,password=password<br \/>      become: yes<br \/><br \/>    - name: Install training code<br \/>      copy:<br \/>        src: training.py<br \/>        dest: \/opt\/training\/training.py<br \/>      become: yes<br \/><br \/>    - name: Install dataset<br \/>      copy:<br \/>        src: dataset.zip<br \/>        dest: \/opt\/training\/dataset.zip<br \/>      become: yes<br \/>      unarchive:<br \/>        src: \/opt\/training\/dataset.zip<br \/>        dest: \/opt\/training\/<br \/>        remote_src: true<br \/><br \/>    - name: Execute training<br \/>      command: python3 \/opt\/training\/training.py<br \/>      become:<br \/>---<br \/>- name: Set up distributed training environment<br \/>  hosts: all<br \/>  tasks:<br \/>    - name: Install Python<br \/>      package:<br \/>        name: python3<br \/>      become: yes<br \/><br \/>    - name: Install PyTorch<br \/>      pip:<br \/>        name: torch<br \/>      become: yes<br \/><br \/>    - name: Install CIFS utilities<br \/>      package:<br \/>        name: cifs-utils<br \/>      become: yes<br \/><br \/>    - name: Mount shared directory<br \/>      mount:<br \/>        path: \/path\/to\/mount\/point<br \/>        src: \/\/10.0.0.1\/shared<br \/>        fstype: cifs<br \/>        opts: username=guest,password=password<br \/>      become: yes<br \/><br \/>    - name: Install training code<br \/>      copy:<br \/>        src: training.py<br \/>        dest: \/opt\/training\/training.py<br \/>      become: yes<br \/><br \/>    - name: Install dataset<br \/>      copy:<br \/>        src: dataset.zip<br \/>        dest: \/opt\/training\/dataset.zip<br \/>      become: yes<br \/>      unarchive:<br \/>        src: \/opt\/training\/dataset.zip<br \/>        dest: \/opt\/training\/<br \/>        remote_src: true<br \/><br \/>    - name: Execute training<br \/>      command: python3 \/opt\/training\/training.py<br \/>      become: yes<br \/><\/pre>\n\n\n\n<p>Create an <code>ansible<\/code> inventory file that specifies the connection information for the computers. For example:<\/p>\n\n\n\n<pre class=\"wp-block-preformatted\">[windows]<br \/>windows_computer ansible_user=username ansible_password=password<br \/><br \/>[linux]<br \/>linux_computer ansible_user=username ansible_password=password<br \/><br \/>[mac]<br \/>mac_computer ansible_user=username ansible_ssh_private_key_file=\/path\/to\/keyfile<br \/><\/pre>\n\n\n\n<p>Use <code>ansible<\/code> to apply the playbook to the computers. For example:<\/p>\n\n\n\n<pre class=\"wp-block-preformatted\">ansible-playbook -i inventory.ini playbook.yml<\/pre>\n\n\n\n<p>To allow a non-technical person to provide the information that <code>ansible<\/code> requires to connect to their computer, you can follow these steps:<\/p>\n\n\n\n<ol>\n<li>Explain to the person what <code>ansible<\/code> is and why you need access to their computer.<\/li>\n\n\n\n<li>Provide the person with the <code>ansible<\/code> inventory file template that you will use to connect to their computer. This should include the hostname or IP address, username, and password or private key for the computer.<\/li>\n\n\n\n<li>Ask the person to fill in the <code>ansible<\/code> inventory file template with the appropriate information for their computer.<\/li>\n\n\n\n<li>To find the hostname or IP address of the computer, the person can do the following:<\/li>\n<\/ol>\n\n\n\n<ul>\n<li>On Windows:\n<ol>\n<li>Press the <code>Windows<\/code> + <code>R<\/code> keys to open the <code>Run<\/code> dialog.<\/li>\n\n\n\n<li>Type <code>cmd<\/code> and press <code>Enter<\/code> to open the command prompt.<\/li>\n\n\n\n<li>Type <code>ipconfig<\/code> and press <code>Enter<\/code>.<\/li>\n\n\n\n<li>Look for the <code>IPv4 Address<\/code> field. This is the IP address of the computer.<\/li>\n<\/ol>\n<\/li>\n\n\n\n<li>On MacOS:\n<ol>\n<li>Click the <code>Apple<\/code> menu and select <code>System Preferences<\/code>.<\/li>\n\n\n\n<li>Click the <code>Network<\/code> icon.<\/li>\n\n\n\n<li>Select the active network connection (e.g., Wi-Fi) from the list on the left.<\/li>\n\n\n\n<li>Click the <code>Advanced<\/code> button.<\/li>\n\n\n\n<li>Click the <code>TCP\/IP<\/code> tab.<\/li>\n\n\n\n<li>The <code>IP address<\/code> field displays the IP address of the computer.<\/li>\n<\/ol>\n<\/li>\n\n\n\n<li>On Linux:\n<ol>\n<li>Open a terminal.<\/li>\n\n\n\n<li>Type <code>ifconfig<\/code> and press <code>Enter<\/code>.<\/li>\n\n\n\n<li>Look for the <code>inet<\/code> field. This is the IP address of the computer.<\/li>\n<\/ol>\n<\/li>\n<\/ul>\n\n\n\n<ol start=\"5\">\n<li>To find the username and password of the computer, the person can do the following:<\/li>\n<\/ol>\n\n\n\n<ul>\n<li>On Windows:\n<ol>\n<li>Press the <code>Windows<\/code> + <code>R<\/code> keys to open the <code>Run<\/code> dialog.<\/li>\n\n\n\n<li>Type <code>control userpasswords2<\/code> and press <code>Enter<\/code> to open the <code>User Accounts<\/code> dialog.<\/li>\n\n\n\n<li>Click the <code>Manage another account<\/code> link.<\/li>\n\n\n\n<li>Click the account that you want to use to connect to the computer.<\/li>\n\n\n\n<li>Click the <code>Change the account name<\/code> or <code>Change the password<\/code> button to view or change the username or password for the account.<\/li>\n<\/ol>\n<\/li>\n\n\n\n<li>On MacOS:\n<ol>\n<li>Click the <code>Apple<\/code> menu and select <code>System Preferences<\/code>.<\/li>\n\n\n\n<li>Click the <code>Users &amp; Groups<\/code> icon.<\/li>\n\n\n\n<li>Click the <code>Lock<\/code> icon and enter the administrator password to make changes.<\/li>\n\n\n\n<li>Click the user account that you want to use to connect to the computer.<\/li>\n\n\n\n<li>Click the <code>Change Password<\/code> button to view or change the password for the account.<\/li>\n<\/ol>\n<\/li>\n\n\n\n<li>On Linux:\n<ol>\n<li>Open a terminal.<\/li>\n\n\n\n<li>Type <code>id<\/code> and press <code>Enter<\/code> to view the current user and<\/li>\n<\/ol>\n<\/li>\n<\/ul>\n","protected":false},"excerpt":{"rendered":"<p>Imagine if you can connect to a friends computer and use that to speed up training of your model. Training ML models is very expensive, and ML techniques require many iterations hence they require speed. The Solution: Distributed Computing Distributed training is a technique that allows you to train machine learning models using multiple computers.&hellip;&nbsp;<a href=\"http:\/\/localhost:8000\/index.php\/practical-guide-for-training-or-fine-tuning-large-language-models\/\" class=\"\" rel=\"bookmark\">Read More &raquo;<span class=\"screen-reader-text\">Practical guide for training or fine tuning large language models<\/span><\/a><\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"neve_meta_sidebar":"","neve_meta_container":"","neve_meta_enable_content_width":"","neve_meta_content_width":0,"neve_meta_title_alignment":"","neve_meta_author_avatar":"","neve_post_elements_order":"","neve_meta_disable_header":"","neve_meta_disable_footer":"","neve_meta_disable_title":"","_themeisle_gutenberg_block_has_review":false,"_ti_tpc_template_sync":false,"_ti_tpc_template_id":""},"categories":[5],"tags":[37,44,78],"_links":{"self":[{"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/posts\/1068"}],"collection":[{"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/comments?post=1068"}],"version-history":[{"count":0,"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/posts\/1068\/revisions"}],"wp:attachment":[{"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/media?parent=1068"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/categories?post=1068"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/localhost:8000\/index.php\/wp-json\/wp\/v2\/tags?post=1068"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}